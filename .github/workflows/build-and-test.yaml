name: Build and test with gRPC SSO service

on:
  pull_request:
    branches:
      - main
      - dev

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Ensure config directories exist
        run: |
          mkdir -p ./config/reframed
          mkdir -p ./config/grpc-sso

      - name: Create .env files
        run: |
          echo "${{ secrets.ENV_CONFIG_TEST_REFRAMED }}" > ./config/reframed/.env
          echo "${{ secrets.ENV_CONFIG_TEST_SSO }}" > ./config/grpc-sso/.env

      - name: Start services with Docker Compose
        run: docker-compose up -d

      - name: Wait for services to be ready
        run: sleep 20

      - name: Run make setup-dev for gRPC SSO service
        run: docker-compose run grpc-sso-service make setup-dev

      - name: Run make setup-dev for Reframed service
        run: docker-compose run reframed make setup-dev

      - name: Run tests for Reframed service
        run: docker-compose run reframed make test

      - name: Check logs for gRPC SSO service
        run: docker-compose logs grpc-sso-service

      - name: Check logs for Reframed service
        run: docker-compose logs reframed

      - name: Notify results
        run: echo "Tests completed!"